%-----------------------------------------------------------------------------
%
%               Template for sigplanconf LaTeX Class
%
% Name:         sigplanconf-template.tex
%
% Purpose:      A template for sigplanconf.cls, which is a LaTeX 2e class
%               file for SIGPLAN conference proceedings.
%
% Author:       Paul C. Anagnostopoulos
%               Windfall Software
%               978 371-2316
%               paul@windfall.com
%
% Created:      15 February 2005
%
%-----------------------------------------------------------------------------


\documentclass[]{sigplanconf}

% The following \documentclass options may be useful:
%
% 10pt          To set in 10-point type instead of 9-point.
% 11pt          To set in 11-point type instead of 9-point.
% authoryear    To obtain author/year citation style instead of numeric.

\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{hyperref}


\newcommand{\squishlist}{\begin{list}{$\bullet$}
  {\setlength{\itemsep}{0pt}
    \setlength{\parsep}{3pt}
    \setlength{\topsep}{3pt}
    \setlength{\partopsep}{0pt}
    \setlength{\leftmargin}{1.5em}
    \setlength{\labelwidth}{1em}
    \setlength{\labelsep}{0.5em}}}

\newcommand{\squishend}{\end{list}}

\begin{document}

\conferenceinfo{CS8803DC 2010}{May 6, Atlanta.} 
\copyrightyear{2010} 
\toappear{Copyright is held by the author.\\
\textit{CS8803DC} May 6, Atlanta.}
%\authorpermission
%\titlebanner{CS8803DC, Spring 2010, Georgia Institute of Technology}        % These are ignored unless
%\preprintfooter{Dynamic Translation for Intel's Loop Stream Decoder}   % 'preprint' option specified.

\title{Daytripper}
\subtitle{Dynamic Translation for Intel's Loop Stream Decoder}

\authorinfo{Nick Black}
           {nickblack@linux.com}

\maketitle

\begin{abstract}
Intel processors since the 65nm Conroe Core\texttrademark2
have included hardware to queue decoded loops directly into the out-of-order
execution engines\footnote{For an excellent comparison of the Loop Stream
Detector to the Pentium 4's trace cache, see \cite{kanter}.}. These ``Loop
Stream Detectors'' (LSD) allow for substantial power savings and, in some
cases, performance improvements. Unfortunately, the LSD can only store
instruction streams meeting a number of architecture-specific restrictions.
The Loop Stream Decoder represents an unmistakable power optimization, can be
definitively verified via the Core\texttrademark i7's LSD\_UOPS performance
counter, and has clearly-defined requirements for successful use. All these
properties make optimizing for the LSD an attractive prospect, especially for
a runtime translator.
\end{abstract}

\category{D.3.4}{Processors}{Compilers}

\terms
Binary translation, instruction decoding

\keywords
Loop Stream Detector, Binary translation, Length-Changing Prefix, MSROM

\section{Introduction}
\cite{inteloptimize}
\begin{figure}[h]
\includegraphics[width=\columnwidth]{texobjs/LSDConroe.jpg}
\caption{The Core\texttrademark  2 Loop Stream Detector}
\label{fig:lsdcorei7}
\end{figure}
Benefits of the original LSD included:
\squishlist
\item The documented ability to shut down instruction fetch and branch prediction hardware.
\item The possibility of shutting down instruction fetch, as explored in other
processor designs \cite{badulescu}.
\squishend

The Loop Stream Detector was improved for the release of the ``Nehalem''
Core i7. Moved after the decoding stages, it now supplies $\mu$ops directly
to execution units (as opposed to instructions to the decoder).
\begin{figure}[h]
\includegraphics[width=\columnwidth]{texobjs/LSDCorei7.jpg}
\caption{The Core\texttrademark  i7 Loop Stream Detector}
\label{fig:lsdcorei7}
\end{figure}
Benefits include:
\squishlist
\item The entire processor frontend can be powered down during LSD streaming,
as opposed to merely the instruction fetching hardware.
\item Length-Changing Prefix stalls, major sources of delays in the frontend,
are eliminated.
\item Stalls due to contention for the single complex instruction decoder are
avoided, as are the extreme delays due to MSROM-based decoding.
\squishend
\section{Related work}
Virtually every reference to the Loop Stream Detector, from GCC bug reports
\cite{gcclsd} to various optimization guides, speaks of supposed performance benefits.

This is wrongheaded.

While it is true that streaming instructions (in the case of Conroe) or $\mu$ops
(in the case of Nehalem) from the Loop Stream Detector bypasses several pipeline stages,
this does not, by itself, represent a gain in throughput. At a saturated steady
state, CPI is independent of pipeline length. The LSD applies only to tight
loops---precisely the sections most easily benefited by branch prediction,
large data caches, advanced prefetching and extensive speculation. In short,
it targets code for which Intel has already spent a decade adding hardware
support (as noted earlier, the LSD \textit{can} remedy certain decoding
perversions specific to the x86 architecture).

The LSD would be highly relevant to research on optimizing for power, were it
not for the facts that:
\squishlist
\item It is present only on energy-hungry high-end x86 processors, poor fits for
systems designed to conserve power.
\item It is only so effective at reducing power consumption due to the large
transistor budget required for high-speed x86 instruction decoding; a classic
RISC processor could not reap nearly such significant benefits.
\squishend
Whether or not the Loop Stream Detector will emerge as the focus of academic
research is thus debatable. This paper appears to be the first investigation
of dynamic translation for the explicit purpose of engaging the LSD.
\appendix
\section{Using the LSD\_UOPS PMC}

Existing open source hardware profiling tools have yet to fully support Core\texttrademark
i7 line of processors. The line represents several combinations of Family,
Model and Stepping numbers \cite{intelcpuid}. The following information is valid
as of 2010--05--06.
\subsection{Linux's \texttt{perf}}
The \texttt{perf} tool, included in Linux source distributions since 2.6.31,
can support LSD\_UOPS via use of a ``raw counter''. Provide

\texttt{-e -r 1a8}

when an event needs be specified; this selects unit mask 0x1 from event 0xa8,
the LSD\_UOPS event \cite{intelsys}.
\subsection{Oprofile}
Oprofile requires a patch to properly identify some Core\texttrademark i7
processors. The author has submitted it to the Oprofile team; it can be found
at:

\url{http://marc.info/?l=linux-kernel&m=127294830417492}.
\acks
Brought to you by Purple Drank\texttrademark. Code like a Champion Today!
\includegraphics[width=\columnwidth]{texobjs/drank.jpg}
Also, I stole my images from Ars Technica.
% We recommend abbrvnat bibliography style.

\bibliographystyle{abbrvnat}
% The bibliography should be embedded for final submission.
\bibliography{cs8803dcproject}

\end{document}
